version: "3.9"

# 使用以下指令啟動 / 關閉
# docker compose -f docker-compose-postgre.yml up -d
# docker compose -f docker-compose-postgre.yml down


services:
  postgres:
    image: postgres:16
    container_name: my-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: myuser
      POSTGRES_PASSWORD: mypassword
      POSTGRES_DB: mydb
    ports:
      - "5001:5432"
    volumes:
      - ./postgre-data:/var/lib/postgresql/data

  pgadmin:
    image: dpage/pgadmin4
    container_name: my-pgadmin
    restart: unless-stopped
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@example.com
      PGADMIN_DEFAULT_PASSWORD: admin123
      PGADMIN_CONFIG_ENHANCED_COOKIE_PROTECTION: "False"
      PGADMIN_CONFIG_WTF_CSRF_ENABLED: "False"
      PGADMIN_CONFIG_WTF_CSRF_CHECK_DEFAULT: "False"
      PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED: "False"
      PGADMIN_SERVER_JSON_FILE: "/servers/servers.json"
    ports:
      - "5000:80"
    volumes:
      - ./pgadmin-data:/var/lib/pgadmin
      - ./postgre.server.json:/servers/servers.json:ro
    depends_on:
      - postgres

  mage:
    image: mageai/mageai:latest
    container_name: my-mage
    # 第一次會自動建立名為 my_project 的 Mage 專案
    command: mage start my_project
    restart: unless-stopped
    depends_on:
      - postgres
    environment:
      # Mage 本身的執行環境
      ENV: dev
      USER_CODE_PATH: /home/src/my_project

      # 提供給 pipeline 用的 DB 連線資訊（在 pipeline 裡可從環境變數拿）
      POSTGRES_DB: mydb
      POSTGRES_USER: myuser
      POSTGRES_PASSWORD: mypassword
      POSTGRES_HOST: postgres
      PG_HOST_PORT: 5432

      # 關閉使用者認證（讓你直接進入 Mage UI，不用登入）
      DISABLE_USER_AUTHENTICATION: "True"


      # （選用）如果你想讓 Mage 把「自己的 metadata」也存到 Postgres，而不是用內建 SQLite：
      # MAGE_DATABASE_CONNECTION_URL: "postgresql+psycopg2://myuser:mypassword@postgres:5432/mydb"
      # 需要符合官方文件說明的格式 :contentReference[oaicite:0]{index=0}

    ports:
      - "6789:6789"
    volumes:
      # 把當前資料夾底下的 mage 資料夾掛到容器內
      - ./mage:/home/src